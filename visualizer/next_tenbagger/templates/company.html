<!DOCTYPE html>
<html>
<head>
    <title>{{ company_name }} ({{ company_code }}) - 企業分析</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .chart-container {
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            background-color: #fff;
        }
        .chart-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .section-title {
            margin-top: 30px;
            margin-bottom: 20px;
            font-weight: 600;
            color: #0d6efd;
            border-bottom: 2px solid #0d6efd;
            padding-bottom: 5px;
            display: inline-block;
        }
        .competitor-card {
            margin-bottom: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        .competitor-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #e0e0e0;
            border-radius: 8px 8px 0 0;
        }
        .competitor-body {
            padding: 15px;
        }
        .competitor-title {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 600;
        }
        .competitor-subtitle {
            color: #6c757d;
            font-size: 0.9rem;
            margin-top: 5px;
        }
        .business-description {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
        }
        .officers-info {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e0e0e0;
            white-space: pre-wrap;
            font-size: 0.9rem;
        }
        .report-diff-container {
            margin-top: 20px;
            display: none;
        }
        .report-diff {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.9rem;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
            max-height: 500px;
            overflow-y: auto;
        }
        .report-selector {
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row mb-4">
            <div class="col-12">
                <h1 class="text-center">{{ company_name }} ({{ company_code }})</h1>
                <p class="text-center text-muted">四半期報告書に基づく財務分析</p>
                <div class="text-center">
                    <a href="/next_tenbagger/" class="btn btn-outline-primary">企業一覧に戻る</a>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <!-- 財務指標チャート -->
                <h3 class="section-title">財務指標チャート（四半期）</h3>
                {% for chart in charts %}
                <div class="chart-container">
                    <h4 class="chart-title">{{ chart.title }}</h4>
                    {{ chart.html|safe }}
                </div>
                {% endfor %}
            </div>

            <div class="col-md-4">
                <!-- 事業内容 -->
                <h3 class="section-title">事業の内容</h3>
                <div class="business-description">
                    {% if business_description %}
                    {{ business_description|safe }}
                    {% else %}
                    <p>事業内容の情報がありません。</p>
                    {% endif %}
                </div>

                <!-- 役員情報 -->
                <h3 class="section-title">役員情報</h3>
                <div class="officers-info">
                    {% if officers_info %}
                    {{ officers_info|safe }}
                    {% else %}
                    <p>役員情報がありません。</p>
                    {% endif %}
                </div>

                <!-- 四半期報告書の差分 -->
                <h3 class="section-title">四半期報告書の差分</h3>
                <div class="report-selector">
                    <div class="row">
                        <div class="col-md-5">
                            <select id="old-report" class="form-select">
                                <option value="">古い報告書を選択</option>
                            </select>
                        </div>
                        <div class="col-md-5">
                            <select id="new-report" class="form-select">
                                <option value="">新しい報告書を選択</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button id="compare-btn" class="btn btn-primary w-100" disabled>比較</button>
                        </div>
                    </div>
                </div>
                <div id="report-diff-container" class="report-diff-container">
                    <div id="report-diff" class="report-diff"></div>
                </div>

                <!-- 競合他社 -->
                <h3 class="section-title">競合他社</h3>
                {% if competitors %}
                    {% for competitor in competitors %}
                    <div class="competitor-card">
                        <div class="competitor-header">
                            <h5 class="competitor-title">{{ competitor.name }}</h5>
                            <p class="competitor-subtitle">コード: {{ competitor.code }}</p>
                        </div>
                        <div class="competitor-body">
                            <h6>事業内容:</h6>
                            <div class="mb-3">
                                {% if competitor.business_description %}
                                {{ competitor.business_description|truncate(200)|safe }}
                                {% else %}
                                <p>事業内容の情報がありません。</p>
                                {% endif %}
                            </div>
                            <a href="/next_tenbagger/{{ competitor.code }}" class="btn btn-sm btn-outline-primary w-100">詳細を見る</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <p>競合他社の情報がありません。</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 四半期報告書一覧を取得
            fetch(`/next_tenbagger/api/securities_reports/${company_code}`)
                .then(response => response.json())
                .then(data => {
                    const reports = data.reports;
                    if (reports && reports.length > 0) {
                        const oldReportSelect = document.getElementById('old-report');
                        const newReportSelect = document.getElementById('new-report');
                        
                        // 報告書をドロップダウンに追加
                        reports.forEach(report => {
                            const option = document.createElement('option');
                            option.value = JSON.stringify(report);
                            option.textContent = report.date;
                            oldReportSelect.appendChild(option.cloneNode(true));
                            newReportSelect.appendChild(option);
                        });
                        
                        // 選択状態の監視
                        const compareBtn = document.getElementById('compare-btn');
                        function checkSelections() {
                            if (oldReportSelect.value && newReportSelect.value && oldReportSelect.value !== newReportSelect.value) {
                                compareBtn.disabled = false;
                            } else {
                                compareBtn.disabled = true;
                            }
                        }
                        
                        oldReportSelect.addEventListener('change', checkSelections);
                        newReportSelect.addEventListener('change', checkSelections);
                        
                        // 比較ボタンのクリックイベント
                        compareBtn.addEventListener('click', function() {
                            const oldReport = JSON.parse(oldReportSelect.value);
                            const newReport = JSON.parse(newReportSelect.value);
                            
                            // 差分を取得
                            fetch(`/next_tenbagger/api/securities_report_diff/${company_code}`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    old_report: oldReport.file,
                                    new_report: newReport.file,
                                    old_date: oldReport.date,
                                    new_date: newReport.date
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                const diffContainer = document.getElementById('report-diff-container');
                                const diffElement = document.getElementById('report-diff');
                                
                                diffElement.textContent = data.diff_text;
                                diffContainer.style.display = 'block';
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('差分の取得中にエラーが発生しました。');
                            });
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        });
    </script>
</body>
</html> 